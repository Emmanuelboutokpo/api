generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(uuid())
  email               String         @unique
  password            String
  googleId            String?        @unique
  refreshToken        String?
  role                UserRole       @default(EMPLOYEE)
  createdAt           DateTime       @default(now())
  disponibilite       Boolean        @default(true)
  commandesAssignees  Commande[]     @relation("CommandeAssignedTo")
  commandesControlees Commande[]     @relation("CommandeControleur")
  commandes           Commande[]
  controles           Controle[]
  notifications       Notification[] @relation("NotificationDestinataire")
  paiementsProcessee  Paiement[]     @relation("PaiementProcessedBy")
  penalites           Penalite[]
  profile             Profile?
  remunerations       Remuneration[]
}

model Profile {
  id        String  @id @default(uuid())
  userId    String  @unique
  firstName String
  lastName  String
  img       String?
  user      User    @relation(fields: [userId], references: [id])
}

model Client {
  id        String     @id @default(uuid())
  firstName String
  lastName  String
  telephone String     @unique
  adresse   String?
  imageUrl  String?
  gender    Gender
  createdAt DateTime   @default(now())
  commandes Commande[]
  mesures   Mesure[]
  paiements Paiement[]
  styles    Style[]    @relation("ClientStyles")

  @@index([firstName])
  @@index([lastName])
  @@index([telephone])
}

model CommandeImage {
  id         String    @id @default(uuid())
  type       ImageType
  url        String
  commandeId String
  createdAt  DateTime  @default(now())
  commande   Commande  @relation(fields: [commandeId], references: [id], onDelete: Cascade)
}

model StyleImage {
  id        String    @id @default(uuid())
  type      ImageType
  url       String
  styleId   String
  createdAt DateTime  @default(now())
  style     Style     @relation(fields: [styleId], references: [id])
}

model Style {
  id        String       @id @default(uuid())
  model     String       @unique
  commandes Commande[]
  images    StyleImage[]
  clients   Client[]     @relation("ClientStyles")

  @@index([model])
}

model MesureType {
  id      String         @id @default(uuid())
  label   String         @unique
  unit    String?
  mesures MesureValeur[]
}

model Mesure {
  id         String         @id @default(uuid())
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  clientId   String
  commandeId String
  client     Client         @relation(fields: [clientId], references: [id])
  commande   Commande       @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  valeurs    MesureValeur[]
}

model MesureValeur {
  id           String     @id @default(uuid())
  valeur       Float
  mesureTypeId String
  mesureId     String
  mesure       Mesure     @relation(fields: [mesureId], references: [id])
  mesureType   MesureType @relation(fields: [mesureTypeId], references: [id])
}

model Commande {
  id                  String          @id @default(uuid())
  description         String
  dateCommande        DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  dateLivraisonPrevue DateTime
  status              CommandeStatus  @default(EN_COURS)
  prix                Float?
  montantAvance       Float?
  audioFile           String?
  clientId            String
  styleId             String
  userId              String
  controleurId        String?
  assignedToId        String?
  assignedTo          User?           @relation("CommandeAssignedTo", fields: [assignedToId], references: [id])
  client              Client          @relation(fields: [clientId], references: [id])
  controleur          User?           @relation("CommandeControleur", fields: [controleurId], references: [id])
  style               Style           @relation(fields: [styleId], references: [id])
  createdBy           User            @relation(fields: [userId], references: [id])
  images              CommandeImage[]
  controles           Controle[]
  fournitures         Fourniture[]
  mesures             Mesure[]
  notifications       Notification[]
  paiements           Paiement[]
  penalites           Penalite[]
  remunerations       Remuneration[]

  @@index([status])
  @@index([clientId])
  @@index([assignedToId])
  @@index([controleurId])
  @@index([dateCommande])
}

model Fourniture {
  id          String   @id @default(uuid())
  designation String
  quantite    Int
  commandeId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  commande    Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)

  @@index([designation])

}

model Controle {
  id           String   @id @default(uuid())
  dateControle DateTime @default(now())
  conforme     Boolean  @default(true)
  remarques    String
  commandeId   String
  controleurId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  commande     Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  controleur   User     @relation(fields: [controleurId], references: [id])
}

model Penalite {
  id           String       @id @default(uuid())
  type         PenaliteType
  montant      Float
  raison       String
  datePenalite DateTime     @default(now())
  employeId    String
  commandeId   String
  createdAt    DateTime     @default(now())
  commande     Commande     @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  employe      User         @relation(fields: [employeId], references: [id])
}

model Remuneration {
  id         String     @id @default(uuid())
  montant    Float
  date       DateTime   @default(now())
  statut     RemuStatus @default(EN_ATTENTE)
  employeId  String
  commandeId String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  commande   Commande   @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  employe    User       @relation(fields: [employeId], references: [id])
}

model Notification {
  id               String      @id @default(uuid())
  commandeId       String
  message          String
  dateNotification DateTime    @default(now())
  status           NotifStatus @default(EN_ATTENTE)
  destinataireId   String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  commande         Commande    @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  destinataire     User?       @relation("NotificationDestinataire", fields: [destinataireId], references: [id])
}

model Paiement {
  id            String         @id @default(uuid())
  montant       Float
  datePaiement  DateTime       @default(now())
  modePaiement  ModePaiement   @default(ESPECES)
  statut        PaiementStatut @default(VALIDE)
  description   String?
  commandeId    String
  clientId      String?
  processedById String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  client        Client?        @relation(fields: [clientId], references: [id])
  commande      Commande       @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  processedBy   User?          @relation("PaiementProcessedBy", fields: [processedById], references: [id])
}

enum ModePaiement {
  ESPECES
  MOBILE_MONEY
  CARTE
  VIREMENT
}

enum PaiementStatut {
  EN_ATTENTE
  VALIDE
  ECHEC
  REMBOURSE
}

enum ImageType {
  MODEL
  TISSU
}

enum UserRole {
  ADMIN
  CONTROLLEUR
  EMPLOYEE
}

enum Gender {
  M
  F
}

enum CommandeStatus {
  EN_COURS
  ASSIGNEE
  MESURE_ENREGISTREE
  EN_PRODUCTION
  EN_CONTROLE
  NON_CONFORME
  RETOUCHE
  PRET
  LIVRE
  RETARD
  ANNULE
}

enum NotifStatus {
  EN_ATTENTE
  ASSIGNATION
  PRET
  RAPPEL_LIVRAISON
  PENALITE
  VALIDATION
  NON_CONFORME
  LIVRAISON_PRET
  RETARD
  CONTROLE
}

enum PenaliteType {
  RETARD
  NON_CONFORME
  AUTRE
}

enum RemuStatus {
  EN_ATTENTE
  PAYEE
  EN_RETARD
}
